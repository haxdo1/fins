<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <link rel="icon" href="https://news.san-andreas.net/download/file.php?avatar=g69_1637211788.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FINS Generator">
  <link rel="apple-touch-icon" href="https://news.san-andreas.net/download/file.php?avatar=g69_1637211788.png">
  <title>FINS Report Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            slate: {
              850: '#151F32',
              900: '#0F172A',
              950: '#020617',
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Clean, professional background */
    body {
      background-color: #f8fafc;
      background-image: radial-gradient(circle at 50% 0%, #e2e8f0 0%, #f8fafc 70%);
      background-attachment: fixed;
      transition: background-color 0.3s ease;
    }

    html.dark body {
      background-color: #020617;
      background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 70%);
    }

    /* Refined Card Style */
    .card-panel {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    html.dark .card-panel {
      background: #0f172a;
      border: 1px solid #1e293b;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* High Contrast Inputs */
    .input-field {
      background: #ffffff;
      border: 1px solid #cbd5e1;
      color: #0f172a;
      transition: all 0.2s ease;
    }

    html.dark .input-field {
      background: #1e293b;
      border: 1px solid #334155;
      color: #f8fafc;
    }

    .input-field:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
      outline: none;
    }

    html.dark .input-field::placeholder {
      color: #64748b;
    }

    /* Primary Button Style */
    .btn-primary {
      background: linear-gradient(to bottom, #4f46e5, #4338ca);
      border: 1px solid #4338ca;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      transition: all 0.15s;
    }

    .btn-primary:hover {
      background: linear-gradient(to bottom, #4338ca, #3730a3);
      border-color: #3730a3;
    }

    .btn-primary:active {
      transform: translateY(1px);
    }
  </style>
</head>

<body class="text-slate-300 min-h-screen font-sans selection:bg-indigo-500/30 selection:text-indigo-200 antialiased">

  <div class="max-w-5xl mx-auto p-6 md:p-12 relative">

    <!-- THEME TOGGLE -->
    <div class="absolute top-6 right-6 md:top-12 md:right-12">
      <button onclick="toggleTheme()" id="themeToggle"
        class="p-2 rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-800 dark:text-slate-200 hover:ring-2 hover:ring-indigo-500 transition-all">
        <svg id="sunIcon" class="w-6 h-6 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z" />
        </svg>
        <svg id="moonIcon" class="w-6 h-6 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
      </button>
    </div>

    <!-- HEADER WITH LOGO AND TITLE -->
    <div class="mb-10 text-center">
      <div class="flex justify-center mb-4">
        <img src="https://news.san-andreas.net/download/file.php?avatar=g69_1637211788.png"
          alt="Financial Regulator Logo" class="h-24 w-24">
      </div>
      <h1
        class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white mb-2 bg-gradient-to-r from-indigo-500 to-purple-500 dark:from-indigo-400 dark:to-purple-400 bg-clip-text text-transparent">
        Financial Regulator Division
      </h1>
      <p class="text-slate-600 dark:text-slate-400 text-lg font-medium">Report Generator
        <small>v1.0</small>
      </p>
    </div>

    <!-- REPORT TYPE SELECTOR -->
    <div class="mb-8 flex justify-center">
      <div class="bg-slate-900 p-1.5 rounded-xl border border-slate-800 flex gap-1 shadow-lg">
        <button id="modeActivity" onclick="switchReportMode('activity')"
          class="px-6 py-2 rounded-lg text-sm font-bold transition-all bg-indigo-600 text-white shadow-md">
          Activity Report
        </button>
        <button id="modeVice" onclick="switchReportMode('vice')"
          class="px-6 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-300">
          Manager Report
        </button>
      </div>
    </div>

    <!-- VICE MANAGER SUB-TAB SELECTOR -->
    <div id="viceSubTabs" class="mb-8 flex justify-center hidden">
      <div class="bg-slate-800 p-1 rounded-lg border border-slate-700 flex gap-1">
        <button id="viceReimbursement" onclick="switchViceSubTab('reimbursement')"
          class="px-4 py-1.5 rounded-md text-xs font-semibold transition-all bg-emerald-600 text-white">
          Reimbursement
        </button>
        <button id="viceProposal" onclick="switchViceSubTab('proposal')"
          class="px-4 py-1.5 rounded-md text-xs font-semibold transition-all text-slate-400 hover:text-slate-200">
          Proposal
        </button>
        <button id="viceWeekly" onclick="switchViceSubTab('weekly')"
          class="px-4 py-1.5 rounded-md text-xs font-semibold transition-all text-slate-400 hover:text-slate-200">
          Weekly Report
        </button>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid lg:grid-cols-12 gap-8 items-start">

      <!-- LEFT COLUMN (Inputs) -->
      <div id="inputColumn" class="lg:col-span-8 space-y-10">

        <!-- IDENTITY CARD -->
        <section id="identitySection">
          <div class="flex items-center gap-2 mb-4 px-1">
            <svg class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Staff Identity</h2>
          </div>
          <div class="card-panel rounded-xl p-6">
            <div class="grid md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label for="staffName" class="block text-sm font-medium text-slate-600 dark:text-slate-400">Full
                  Name</label>
                <input id="staffName" class="w-full p-2.5 rounded-lg input-field text-sm" placeholder="e.g. John Doe"
                  oninput="saveIdentity(); generateBBCode()">
              </div>
              <div class="space-y-2">
                <label for="rank" class="block text-sm font-medium text-slate-600 dark:text-slate-400">Current
                  Rank</label>
                <input id="rank" class="w-full p-2.5 rounded-lg input-field text-sm" placeholder="e.g. Senior Officer"
                  oninput="saveIdentity(); generateBBCode()">
              </div>

              <!-- VICE MANAGER SPECIFIC FIELDS -->
              <div class="space-y-2 vice-only hidden">
                <label for="targetManager" class="block text-sm font-medium text-slate-600 dark:text-slate-400">Target
                  Manager</label>
                <input id="targetManager" class="w-full p-2.5 rounded-lg input-field text-sm"
                  placeholder="e.g. Mr Schafer Eginhardt" oninput="saveIdentity(); generateBBCode()">
              </div>
              <div class="space-y-2 vice-only hidden">
                <label for="reportNum" class="block text-sm font-medium text-slate-600 dark:text-slate-400">Month
                  Number</label>
                <input id="reportNum" class="w-full p-2.5 rounded-lg input-field text-sm" placeholder="e.g. #12"
                  oninput="saveIdentity(); generateBBCode()">
              </div>
              <div class="space-y-2 md:col-span-2 vice-only hidden">
                <label for="signatureUrl" class="block text-sm font-medium text-slate-600 dark:text-slate-400">Signature
                  Image URL</label>
                <input id="signatureUrl" class="w-full p-2.5 rounded-lg input-field text-sm" placeholder="https://..."
                  oninput="saveIdentity(); generateBBCode()">
              </div>
            </div>
          </div>
        </section>

        <!-- REIMBURSEMENT SECTION -->
        <section>
          <div class="flex justify-between items-end mb-4 px-1">
            <div class="flex items-center gap-2">
              <div class="w-1 h-5 bg-emerald-500 rounded-full"></div>
              <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Reimbursements</h2>
            </div>
            <button onclick="addReim()"
              class="text-sm font-medium text-emerald-400 hover:text-emerald-300 flex items-center gap-1 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Add Item
            </button>
          </div>
          <div id="reimContainer" class="space-y-4"></div>
        </section>

        <!-- PROPOSAL SECTION -->
        <section id="proposalSection">
          <div class="flex justify-between items-end mb-4 px-1">
            <div class="flex items-center gap-2">
              <div class="w-1 h-5 bg-blue-500 rounded-full"></div>
              <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Proposals</h2>
            </div>
            <button onclick="addProp()"
              class="text-sm font-medium text-blue-400 hover:text-blue-300 flex items-center gap-1 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Add Item
            </button>
          </div>
          <div id="propContainer" class="space-y-4"></div>
        </section>

        <!-- WEEKLY REPORT SECTION -->
        <section id="weeklySection" class="hidden space-y-6">
          <div class="card-panel rounded-xl p-6 space-y-4">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Weekly Report Details</h2>

            <div class="grid md:grid-cols-3 gap-6">
              <div class="space-y-2">
                <label class="block text-sm font-medium text-slate-600 dark:text-slate-400">Report Date</label>
                <input id="reportDate" class="w-full p-2.5 rounded-lg input-field text-sm"
                  placeholder="e.g. 26 Jan 2026" oninput="saveIdentity(); generateBBCode()">
              </div>
              <div class="space-y-2">
                <label class="block text-sm font-medium text-slate-600 dark:text-slate-400">New Members</label>
                <textarea id="newMembers" class="w-full p-2.5 rounded-lg input-field text-sm h-24 custom-scrollbar"
                  placeholder="List new members (hyphenated)..." oninput="generateBBCode()"></textarea>
              </div>
              <div class="space-y-2">
                <label class="block text-sm font-medium text-slate-600 dark:text-slate-400">Transfer Members</label>
                <textarea id="transferMembers" class="w-full p-2.5 rounded-lg input-field text-sm h-24 custom-scrollbar"
                  placeholder="List transfer members (hyphenated)..." oninput="generateBBCode()"></textarea>
              </div>
            </div>

            <div class="grid md:grid-cols-4 gap-6">
              <div class="md:col-span-3 space-y-2">
                <label class="block text-sm font-medium text-slate-600 dark:text-slate-400">Summary for AI
                  Guidance</label>
                <textarea id="aiSummary" class="w-full p-2.5 rounded-lg input-field text-sm h-20 custom-scrollbar"
                  placeholder="Briefly describe this week's highlights to help the AI (e.g. Holidays, structure change)..."
                  oninput="generateBBCode()"></textarea>
              </div>
              <div class="space-y-2">
                <label class="block text-sm font-medium text-slate-600 dark:text-slate-400">Report Tone</label>
                <select id="reportTone" class="w-full p-2.5 rounded-lg input-field text-sm"
                  onchange="saveIdentity(); generateBBCode()">
                  <option value="Professional & Formal">Formal</option>
                  <option value="Friendly & Engaging">Friendly</option>
                  <option value="Strict & Direct">Strict</option>
                  <option value="Concise & Short">Concise</option>
                </select>
                <p class="text-[10px] text-slate-500 px-1">Changes how the AI writes the report paragraphs.</p>
              </div>
            </div>

            <div
              class="flex flex-col sm:flex-row gap-4 items-end bg-slate-950/50 p-4 rounded-xl border border-slate-800">
              <div class="flex-1 w-full space-y-2">
                <label for="geminiKey"
                  class="block text-xs font-bold text-indigo-400 uppercase tracking-wider hover:underline"><a
                    href="https://aistudio.google.com/app/api-keys" target="_blank">Gemini
                    API Key </a></label>
                <input id="geminiKey" type="password" class="w-full p-2.5 rounded-lg input-field text-sm"
                  placeholder="Paste your Gemini API key here" oninput="saveIdentity()">
              </div>
              <button onclick="generateWithAI()" id="aiBtn"
                class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2.5 rounded-lg font-bold transition-all shadow-md flex items-center justify-center gap-2">
                <svg class="w-5 h-5 ai-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                AI Automate
              </button>
            </div>

            <div class="space-y-4 mt-6">
              <div class="space-y-2">
                <label class="block text-sm font-medium text-slate-600 dark:text-slate-400">Report</label>
                <textarea id="aiReport" class="w-full p-2.5 rounded-lg input-field text-sm h-32 custom-scrollbar"
                  oninput="generateBBCode()"></textarea>
              </div>
              <div class="space-y-2">
                <label class="block text-sm font-medium text-slate-600 dark:text-slate-400">Division Condition</label>
                <textarea id="aiCondition" class="w-full p-2.5 rounded-lg input-field text-sm h-24 custom-scrollbar"
                  oninput="generateBBCode()"></textarea>
              </div>
              <div class="space-y-2">
                <label class="block text-sm font-medium text-slate-600 dark:text-slate-400">Constraints On The
                  Division</label>
                <textarea id="aiConstraints" class="w-full p-2.5 rounded-lg input-field text-sm h-24 custom-scrollbar"
                  oninput="generateBBCode()"></textarea>
              </div>
              <div class="space-y-2">
                <label class="block text-sm font-medium text-slate-600 dark:text-slate-400">Additional
                  Information</label>
                <textarea id="additionalInfo" class="w-full p-2.5 rounded-lg input-field text-sm h-20 custom-scrollbar"
                  placeholder="-" oninput="generateBBCode()"></textarea>
              </div>
            </div>
          </div>
        </section>

      </div>

      <!-- RIGHT COLUMN (Actions & Output) -->
      <div class="lg:col-span-4 lg:sticky lg:top-8 space-y-6">

        <!-- ACTIONS -->
        <div class="card-panel p-5 rounded-xl space-y-4">
          <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Actions</h3>

          <button onclick="generateBBCode()"
            class="w-full btn-primary text-white p-3 rounded-lg font-semibold flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Generate Code
          </button>

          <button onclick="copyBBCode()"
            class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-300 hover:text-white p-3 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
            </svg>
            Copy to Clipboard
          </button>
        </div>

        <!-- OUTPUT AREA -->
        <div>
          <!-- Tabs -->
          <div class="flex gap-2 px-1">
            <button id="tabSource" onclick="switchTab('source')"
              class="px-3 py-2 rounded-t-lg bg-slate-950 text-indigo-400 font-bold text-xs uppercase tracking-wider border-t border-x border-slate-800 hover:bg-slate-900 transition">Source
              Code</button>
            <button id="tabPreview" onclick="switchTab('preview')"
              class="px-3 py-2 rounded-t-lg bg-transparent text-slate-500 font-bold text-xs uppercase tracking-wider hover:text-slate-300 transition border-t border-x border-transparent">Real
              Preview</button>
          </div>

          <!-- Containers -->
          <div class="relative group">
            <!-- Source Textarea -->
            <textarea id="output"
              class="w-full h-96 bg-slate-950 border border-slate-800 rounded-b-xl rounded-tr-xl p-4 font-mono text-xs text-slate-400 focus:outline-none focus:border-indigo-500/50 transition-colors resize-none custom-scrollbar shadow-inner block"
              readonly placeholder="// Generated code will appear here..."></textarea>

            <!-- Preview Div -->
            <div id="preview"
              class="hidden w-full h-96 bg-slate-50 border border-slate-800 rounded-b-xl rounded-tr-xl p-6 overflow-y-auto custom-scrollbar shadow-inner text-slate-900 font-sans text-sm">
              <div class="flex flex-col items-center justify-center h-full text-slate-400">
                <svg class="w-10 h-10 mb-2 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                <p>Generate code to see preview</p>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>

  <script>
    /* ===== TABS ===== */
    function toggleTheme() {
      const html = document.documentElement;
      if (html.classList.contains('dark')) {
        html.classList.remove('dark');
      } else {
        html.classList.add('dark');
      }
      saveIdentity();
    }

    function switchTab(tab) {
      const sourceBtn = document.getElementById('tabSource');
      const previewBtn = document.getElementById('tabPreview');
      const sourceDiv = document.getElementById('output');
      const previewDiv = document.getElementById('preview');

      if (tab === 'source') {
        sourceBtn.className = "px-3 py-2 rounded-t-lg bg-slate-950 text-indigo-400 font-bold text-xs uppercase tracking-wider border-t border-x border-slate-800 transition";
        previewBtn.className = "px-3 py-2 rounded-t-lg bg-transparent text-slate-500 font-bold text-xs uppercase tracking-wider hover:text-slate-300 transition border-t border-x border-transparent";
        sourceDiv.classList.remove('hidden');
        previewDiv.classList.add('hidden');
      } else {
        sourceBtn.className = "px-3 py-2 rounded-t-lg bg-transparent text-slate-500 font-bold text-xs uppercase tracking-wider hover:text-slate-300 transition border-t border-x border-transparent";
        previewBtn.className = "px-3 py-2 rounded-t-lg bg-slate-50 text-indigo-600 font-bold text-xs uppercase tracking-wider border-t border-x border-slate-800 transition";
        sourceDiv.classList.add('hidden');
        previewDiv.classList.remove('hidden');
      }
    }
    /* ===== WEEK RANGE ===== */
    function getWeekRange(date = new Date()) {
      const start = (date.getMonth() * 6) + 1; // Approx
      return {
        start,
        end: start + 4,
        month: date.toLocaleString('en-US', { month: 'long' })
      };
    }

    /* ===== GET MONTH FROM WEEK NUMBER ===== */
    function getMonthFromWeek(weekNumber) {
      // Assuming 4-5 weeks per month, calculate which month this week belongs to
      // Week 1-4 = January, 5-9 = February, 10-13 = March, etc.
      const weekNum = parseInt(weekNumber) || 1;

      // Calculate month index (0-11) based on week number
      // Using 4.33 weeks per month average (52 weeks / 12 months)
      let monthIndex = Math.floor((weekNum - 1) / 4.33);

      // Ensure monthIndex is within valid range (0-11)
      monthIndex = Math.max(0, Math.min(11, monthIndex));

      // Create a date object for that month
      const date = new Date(new Date().getFullYear(), monthIndex, 1);
      return date.toLocaleString('en-US', { month: 'long' });
    }

    /* ===== HELPERS ===== */
    function bbItem(url, text) {
      return url ? `[*][url=${url}]${text}[/url]\n` : '';
    }

    let currentMode = 'activity';
    let viceSubTab = 'reimbursement'; // Default to reimbursement

    function switchReportMode(mode) {
      currentMode = mode;
      const activityBtn = document.getElementById('modeActivity');
      const viceBtn = document.getElementById('modeVice');
      const viceFields = document.querySelectorAll('.vice-only');
      const proposalSection = document.getElementById('proposalSection');
      const viceSubTabs = document.getElementById('viceSubTabs');
      const reimSection = document.querySelector('#reimContainer').closest('section');

      if (mode === 'activity') {
        activityBtn.className = "px-6 py-2 rounded-lg text-sm font-bold transition-all bg-indigo-600 text-white shadow-md";
        viceBtn.className = "px-6 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-300";
        viceFields.forEach(f => f.classList.add('hidden'));
        proposalSection.classList.remove('hidden');
        reimSection.classList.remove('hidden');
        viceSubTabs.classList.add('hidden');
        document.getElementById('weeklySection').classList.add('hidden');
        document.querySelectorAll('.nominal-field').forEach(f => f.classList.add('hidden'));
        document.querySelectorAll('.activity-links').forEach(f => f.classList.remove('hidden'));
        document.querySelectorAll('.vice-links').forEach(f => f.classList.add('hidden'));
        document.querySelectorAll('.manager-field').forEach(f => f.classList.add('hidden'));
        document.querySelectorAll('.type-field').forEach(f => f.classList.add('sm:col-span-3'));
      } else {
        viceBtn.className = "px-6 py-2 rounded-lg text-sm font-bold transition-all bg-indigo-600 text-white shadow-md";
        activityBtn.className = "px-6 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-300";
        viceFields.forEach(f => f.classList.remove('hidden'));
        viceSubTabs.classList.remove('hidden');
        document.querySelectorAll('.nominal-field').forEach(f => f.classList.remove('hidden'));
        document.querySelectorAll('.activity-links').forEach(f => f.classList.add('hidden'));
        document.querySelectorAll('.vice-links').forEach(f => f.classList.remove('hidden'));
        document.querySelectorAll('.manager-field').forEach(f => f.classList.remove('hidden'));
        document.querySelectorAll('.type-field').forEach(f => f.classList.remove('sm:col-span-3'));

        // Apply current sub-tab selection
        switchViceSubTab(viceSubTab);
      }
      generateBBCode();
    }

    function switchViceSubTab(subTab) {
      viceSubTab = subTab;
      const reimBtn = document.getElementById('viceReimbursement');
      const propBtn = document.getElementById('viceProposal');
      const weeklyBtn = document.getElementById('viceWeekly');
      const proposalSection = document.getElementById('proposalSection');
      const reimSection = document.querySelector('#reimContainer').closest('section');
      const weeklySection = document.getElementById('weeklySection');

      // Reset buttons
      [reimBtn, propBtn, weeklyBtn].forEach(btn => {
        btn.className = "px-4 py-1.5 rounded-md text-xs font-semibold transition-all text-slate-400 hover:text-slate-200";
      });

      // Hide all
      reimSection.classList.add('hidden');
      proposalSection.classList.add('hidden');
      weeklySection.classList.add('hidden');

      if (subTab === 'reimbursement') {
        reimBtn.className = "px-4 py-1.5 rounded-md text-xs font-semibold transition-all bg-emerald-600 text-white";
        reimSection.classList.remove('hidden');
      } else if (subTab === 'proposal') {
        propBtn.className = "px-4 py-1.5 rounded-md text-xs font-semibold transition-all bg-blue-600 text-white";
        proposalSection.classList.remove('hidden');
      } else if (subTab === 'weekly') {
        weeklyBtn.className = "px-4 py-1.5 rounded-md text-xs font-semibold transition-all bg-indigo-600 text-white";
        weeklySection.classList.remove('hidden');
      }
      generateBBCode();
    }

    function saveIdentity() {
      localStorage.setItem('fins_staffName', document.getElementById('staffName').value);
      localStorage.setItem('fins_rank', document.getElementById('rank').value);
      localStorage.setItem('fins_targetManager', document.getElementById('targetManager').value);
      localStorage.setItem('fins_reportNum', document.getElementById('reportNum').value);
      localStorage.setItem('fins_signatureUrl', document.getElementById('signatureUrl').value);
      localStorage.setItem('fins_mode', currentMode);
      localStorage.setItem('fins_geminiKey', document.getElementById('geminiKey').value);

      // Weekly Report fields
      localStorage.setItem('fins_newMembers', document.getElementById('newMembers').value);
      localStorage.setItem('fins_transferMembers', document.getElementById('transferMembers').value);
      localStorage.setItem('fins_aiSummary', document.getElementById('aiSummary').value);
      localStorage.setItem('fins_aiReport', document.getElementById('aiReport').value);
      localStorage.setItem('fins_aiCondition', document.getElementById('aiCondition').value);
      localStorage.setItem('fins_aiConstraints', document.getElementById('aiConstraints').value);
      localStorage.setItem('fins_additionalInfo', document.getElementById('additionalInfo').value);
      localStorage.setItem('fins_reportDate', document.getElementById('reportDate').value);
      localStorage.setItem('fins_reportTone', document.getElementById('reportTone').value);
      localStorage.setItem('fins_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    }

    function loadIdentity() {
      const savedName = localStorage.getItem('fins_staffName');
      const savedRank = localStorage.getItem('fins_rank');
      const savedTarget = localStorage.getItem('fins_targetManager');
      const savedNum = localStorage.getItem('fins_reportNum');
      const savedSig = localStorage.getItem('fins_signatureUrl');
      const savedMode = localStorage.getItem('fins_mode');
      const savedKey = localStorage.getItem('fins_geminiKey');
      const savedTheme = localStorage.getItem('fins_theme');

      if (savedName) document.getElementById('staffName').value = savedName;
      if (savedRank) document.getElementById('rank').value = savedRank;
      if (savedTarget) document.getElementById('targetManager').value = savedTarget;
      if (savedNum) document.getElementById('reportNum').value = savedNum;
      if (savedSig) document.getElementById('signatureUrl').value = savedSig;
      if (savedMode) switchReportMode(savedMode);
      if (savedKey) document.getElementById('geminiKey').value = savedKey;

      if (savedTheme === 'light') {
        document.documentElement.classList.remove('dark');
      } else {
        document.documentElement.classList.add('dark');
      }

      // Weekly Report fields load
      const fields = ['newMembers', 'transferMembers', 'aiSummary', 'aiReport', 'aiCondition', 'aiConstraints', 'additionalInfo', 'reportDate', 'reportTone'];
      fields.forEach(f => {
        const val = localStorage.getItem('fins_' + f);
        if (val) document.getElementById(f).value = val;
      });
    }

    /* ===== PARSER ===== */
    function parseBBCode(text) {
      if (!text) return '';
      let html = text
        .replace(/</g, "&lt;").replace(/>/g, "&gt;") // Sanitize HTML
        .replace(/\[center\](.*?)\[\/center\]/gs, '<div class="text-center">$1</div>')
        .replace(/\[right\](.*?)\[\/right\]/gs, '<div class="text-right">$1</div>')
        .replace(/\[b\](.*?)\[\/b\]/gs, '<b>$1</b>')
        .replace(/\[i\](.*?)\[\/i\]/gs, '<i>$1</i>')
        .replace(/\[img\](.*?)\[\/img\]/g, '<img src="$1" class="mx-auto max-w-full rounded shadow-sm my-2" style="max-height:100px; display: inline-block;">')
        .replace(/\[url=(.*?)\](.*?)\[\/url\]/g, '<a href="$1" target="_blank" class="text-blue-600 hover:underline">$2</a>')
        .replace(/\[size=150\](.*?)\[\/size\]/gs, '<span class="text-xl font-bold">$1</span>')
        .replace(/\[color=#FFFFFF\](.*?)\[\/color\]/gs, '<span style="color:white">$1</span>')
        .replace(/\[color=white\](.*?)\[\/color\]/gs, '<span style="color:white">$1</span>')
        .replace(/\[divbox=darkblue\]/g, '<div class="bg-blue-900 p-4 rounded-lg text-white mb-2 shadow-sm start-divbox">')
        .replace(/\[divbox=white\]/g, '<div class="bg-white p-4 rounded-lg text-slate-900 mb-2 border border-slate-200 shadow-sm start-divbox">')
        .replace(/\[\/divbox\]/g, '</div>')
        .replace(/\[hr\]\[\/hr\]/g, '<hr class="my-4 border-slate-300">')
        .replace(/\[secspoiler=(.*?)\]/g, '<details class="mb-2 bg-slate-50 border border-slate-200 rounded overflow-hidden"><summary class="bg-slate-200 p-2 font-semibold cursor-pointer text-slate-700 hover:bg-slate-300 transition">$1</summary><div class="p-3">')
        .replace(/\[\/secspoiler\]/g, '</div></details>')
        .replace(/\[list=1\]/g, '<ol class="list-decimal pl-5 space-y-1">')
        .replace(/\[\/list\]/g, '</ol>')
        .replace(/\[\*\]/g, '<li class="marker:text-slate-400">')
        .replace(/\[table\]/g, '<table class="w-full border-collapse border border-slate-300 my-4">')
        .replace(/\[\/table\]/g, '</table>')
        .replace(/\[tr\]/g, '<tr class="border-b border-slate-200">')
        .replace(/\[\/tr\]/g, '</tr>')
        .replace(/\[th\]/g, '<th class="p-2 border border-slate-300 bg-slate-100 text-left font-bold">')
        .replace(/\[\/th\]/g, '</th>')
        .replace(/\[td\]/g, '<td class="p-2 border border-slate-300">')
        .replace(/\[\/td\]/g, '</td>')
        .replace(/\[cell\]\[\/cell\]/g, '<td class="p-2 border border-slate-300"></td>')
        .replace(/\n\n/g, '<br>') // Simple line breaks
        .replace(/\n/g, '<br>'); // Simple line breaks
      return html;
    }

    /* ===== CARD TEMPLATES ===== */
    let reimCount = 0, propCount = 0;

    function addReim() {
      reimCount++;
      const html = `
  <div class="card-panel rounded-xl p-5 relative animate-fade-in group">
    <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-800">
      <h3 class="font-medium text-emerald-500 text-sm">Reimbursement #${reimCount}</h3>
      <button onclick="this.closest('.card-panel').remove(); generateBBCode()" class="text-slate-600 hover:text-red-400 transition-colors" title="Remove">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>
    <div class="space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
        <div class="sm:col-span-2">
          <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Name</label>
          <input class="w-full p-2.5 rounded-lg input-field sm:text-sm person" placeholder="e.g. Ismail Rothschild" oninput="generateBBCode()">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Week</label>
          <input type="number" class="w-full p-2.5 rounded-lg input-field sm:text-sm week-num" placeholder="Auto" oninput="generateBBCode()">
        </div>
        <div class="nominal-field ${currentMode === 'activity' ? 'hidden' : ''}">
          <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Nominal ($)</label>
          <input type="number" class="w-full p-2.5 rounded-lg input-field sm:text-sm nominal" placeholder="e.g. 500" oninput="generateBBCode()">
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 activity-links ${currentMode === 'vice' ? 'hidden' : ''}">
        <div>
           <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Received URL</label>
           <input class="w-full p-2.5 rounded-lg input-field sm:text-sm received" placeholder="https://..." oninput="generateBBCode()">
        </div>
        <div>
           <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Accepted URL</label>
           <input class="w-full p-2.5 rounded-lg input-field sm:text-sm accepted" placeholder="https://..." oninput="generateBBCode()">
        </div>
        <div>
           <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Funds Given URL</label>
           <input class="w-full p-2.5 rounded-lg input-field sm:text-sm fund" placeholder="https://..." oninput="generateBBCode()">
        </div>
      </div>
      <div class="vice-links ${currentMode === 'activity' ? 'hidden' : ''}">
         <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Proof URL</label>
         <input class="w-full p-2.5 rounded-lg input-field sm:text-sm proof" placeholder="https://..." oninput="generateBBCode()">
      </div>
    </div>
  </div>`;
      reimContainer.insertAdjacentHTML('beforeend', html);
      generateBBCode();
    }

    function addProp() {
      propCount++;
      const html = `
  <div class="card-panel rounded-xl p-5 relative animate-fade-in group">
    <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-800">
      <h3 class="font-medium text-blue-500 text-sm">Proposal #${propCount}</h3>
      <button onclick="this.closest('.card-panel').remove(); generateBBCode()" class="text-slate-600 hover:text-red-400 transition-colors" title="Remove">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>
    <div class="space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
         <div class="manager-field">
            <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Manager</label>
            <input class="w-full p-2.5 rounded-lg input-field sm:text-sm manager" placeholder="e.g. Jason Sullivan" oninput="generateBBCode()">
         </div>
         <div class="type-field">
            <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Type</label>
            <input class="w-full p-2.5 rounded-lg input-field sm:text-sm type" placeholder="e.g. CC Salary Mar 2025" oninput="generateBBCode()">
         </div>
         <div class="nominal-field ${currentMode === 'activity' ? 'hidden' : ''}">
           <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Nominal ($)</label>
           <input type="number" class="w-full p-2.5 rounded-lg input-field sm:text-sm nominal" placeholder="e.g. 20900" oninput="generateBBCode()">
         </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 activity-links ${currentMode === 'vice' ? 'hidden' : ''}">
        <div>
           <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Received URL</label>
           <input class="w-full p-2.5 rounded-lg input-field sm:text-sm received" placeholder="https://..." oninput="generateBBCode()">
        </div>
        <div>
           <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Accepted URL</label>
           <input class="w-full p-2.5 rounded-lg input-field sm:text-sm accepted" placeholder="https://..." oninput="generateBBCode()">
        </div>
        <div>
           <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Funds Given URL</label>
           <input class="w-full p-2.5 rounded-lg input-field sm:text-sm fund" placeholder="https://..." oninput="generateBBCode()">
        </div>
      </div>
      <div class="vice-links ${currentMode === 'activity' ? 'hidden' : ''}">
         <label class="block text-xs font-medium text-slate-500 mb-1.5 pl-1">Proof URL</label>
         <input class="w-full p-2.5 rounded-lg input-field sm:text-sm proof" placeholder="https://..." oninput="generateBBCode()">
      </div>
    </div>
  </div>`;
      propContainer.insertAdjacentHTML('beforeend', html);
      generateBBCode();
    }

    /* ===== GENERATE ===== */
    function generateBBCode() {
      const week = getWeekRange();
      let reimText = '', propText = '', reimTableRows = '', propTableRows = '';
      let reimTotalNominal = 0, propTotalNominal = 0;
      let reimCounter = 0, propCounter = 0;

      document.querySelectorAll('#reimContainer > div').forEach(card => {
        reimCounter++;
        const name = card.querySelector('.person').value || 'Unknown';
        const itemWeek = card.querySelector('.week-num').value || week.start;
        const nominalStr = card.querySelector('.nominal').value || '0';
        const nominal = parseInt(nominalStr.replace(/[^0-9]/g, '')) || 0;
        const received = card.querySelector('.received').value;
        const accepted = card.querySelector('.accepted').value;
        const fund = card.querySelector('.fund').value;
        const proof = card.querySelector('.proof') ? card.querySelector('.proof').value : '';

        // Get the correct month based on the week number
        const itemMonth = getMonthFromWeek(itemWeek);

        reimTotalNominal += nominal;

        // Activity Mode TEXT
        reimText +=
          bbItem(received, `[RECEIVED] Reimbursement ${name} (Week ${itemWeek} / ${itemMonth})`) +
          bbItem(accepted, `[ACCEPTED] Reimbursement ${name} (Week ${itemWeek} / ${itemMonth})`) +
          bbItem(fund, `[FUNDS HAVE BEEN GIVEN] Reimbursement ${name} (Week ${itemWeek} / ${itemMonth})`);

        // Vice Manager Mode TABLE ROW
        reimTableRows += `[tr]
    [td]${reimCounter}[/td]
    [td][i]${name}[/i][/td]
    [td][i]Reimbursement ${name} (Week ${itemWeek} / ${itemMonth})[/i][/td]
    [td][i]$${nominal.toLocaleString('en-US')}[/i][/td]
    [td][url=${proof || fund || accepted || received || '#'}]Proof[/url][/td]
[/tr]
`;
      });

      document.querySelectorAll('#propContainer > div').forEach(card => {
        propCounter++;
        const manager = card.querySelector('.manager').value || 'Unknown';
        const type = card.querySelector('.type').value || 'Proposal';
        const nominalStr = card.querySelector('.nominal') ? card.querySelector('.nominal').value || '0' : '0';
        const nominal = parseInt(nominalStr.replace(/[^0-9]/g, '')) || 0;
        const received = card.querySelector('.received').value;
        const accepted = card.querySelector('.accepted').value;
        const fund = card.querySelector('.fund').value;
        const proof = card.querySelector('.proof') ? card.querySelector('.proof').value : '';

        propTotalNominal += nominal;

        // Activity Mode TEXT
        propText +=
          bbItem(received, `[PROPOSAL] ${type} - RECEIVE`) +
          bbItem(accepted, `[PROPOSAL] ${type} - ACCEPTED`) +
          bbItem(fund, `[PROPOSAL] ${type} - FUNDS HAVE BEEN GIVEN`);

        // Vice Manager Mode TABLE ROW
        propTableRows += `[tr]
    [td]${propCounter}[/td]
    [td][i]${manager}[/i][/td]
    [td][i]${type}[/i][/td]
    [td][i]$${nominal.toLocaleString('en-US')}[/i][/td]
    [td][url=${proof || fund || accepted || received || '#'}]Proof[/url][/td]
[/tr]
`;
      });

      const staffName = document.getElementById('staffName').value || '-';
      const rank = document.getElementById('rank').value || '-';
      const targetManager = document.getElementById('targetManager').value || 'Mr Schafer Eginhardt';
      const reportNum = document.getElementById('reportNum').value || '#12';
      const sigUrl = document.getElementById('signatureUrl').value || 'https://www.upload.ee/image/17958074/signature__1___1_.png';

      let bbCode = '';

      if (currentMode === 'activity') {
        // Get current month number (1-12)
        const currentMonthNumber = new Date().getMonth() + 1;

        bbCode = `[divbox=darkblue][divbox=white]

[center][img]https://news.san-andreas.net/download/file.php?avatar=g69_1637211788.png[/img][/center]
[hr][/hr]
[divbox=darkblue][color=#FFFFFF][center][size=150][b]Financial Regulator Activity Report - #${currentMonthNumber}[/b][/size][/center][/color][/divbox]
[hr][/hr]
[b]Name[/b] : ${staffName}
[b]Current Rank[/b] : ${rank}
[b]Week[/b] : Week #${week.start} - Week #${week.end}

[b]Report:[/b]
[secspoiler=Reimbursement]
[list=1]
${reimText || '[*]No reimbursement activity'}
[/list]
[/secspoiler]

[secspoiler=Proposal]
[list=1]
${propText || '[*]No proposal activity'}
[/list]
[/secspoiler]
[/divbox][/divbox]`;
      } else {
        // Vice Manager Report - show selected sub-tab
        if (viceSubTab === 'reimbursement') {
          bbCode = `[divbox=darkblue][divbox=white]

[center][img]https://news.san-andreas.net/download/file.php?avatar=g69_1637211788.png[/img]

[divbox=darkblue][center][size=150][color=white][b]MONTHLY VICE MANAGER REPORT - ${reportNum}[/b][/color][/size][/center][/divbox]
[hr][/hr]

Dear, ${targetManager}

Best wishes to all of us,

I the financial supervisor, would like to submit a monthly report regarding the company's financial condition. This report includes important information about the company's financial performance during the previous month.
During this month, our finance team and I have conducted an in-depth analysis of the company's financial statements. Here are the main points I want to convey:


[b]Reimbursement:[/b]
[table]
[tr]
    [th]No[/th]
    [th]Name[/th]
    [th]Name of activity[/th]
    [th]Nominal[/th]
    [th]Proof[/th]
[/tr]
${reimTableRows || '[tr][td colspan=5][i]No reimbursement activity[/i][/td][/tr]'}${reimTableRows ? `[tr]
[cell][/cell]
[cell][/cell]
    [td][b]TOTAL[/b][/td]
    [td][b]$${reimTotalNominal.toLocaleString('en-US')}[/b][/td]
[cell][/cell]
[/tr]` : ''}
[/table]

I have also said that our finance team remains committed to providing the necessary support and information to management in making strategic decisions related to company finances. Thank you for the attention and trust given. If you have any additional questions or requests, please feel free to contact me.


[right]Sincerly,
[img]${sigUrl}[/img]
${rank}, ${staffName}[/right]

[/divbox][/divbox]`;
        } else if (viceSubTab === 'proposal') {
          // Proposal sub-tab
          bbCode = `[divbox=darkblue][divbox=white]

[center][img]https://news.san-andreas.net/download/file.php?avatar=g69_1637211788.png[/img]

[divbox=darkblue][center][size=150][color=white][b]MONTHLY VICE MANAGER REPORT - ${reportNum}[/b][/color][/size][/center][/divbox]
[hr][/hr]

Dear, ${targetManager}

Best wishes to all of us,

I the financial supervisor, would like to submit a monthly report regarding the company's financial condition. This report includes important information about the company's financial performance during the previous month.
During this month, our finance team and I have conducted an in-depth analysis of the company's financial statements. Here are the main points I want to convey:


[b]Proposal:[/b]
[table]
[tr]
    [th]No[/th]
    [th]Name[/th]
    [th]Name of activity[/th]
    [th]Nominal[/th]
    [th]Proof[/th]
[/tr]
${propTableRows || '[tr][td colspan=5][i]No proposal activity[/i][/td][/tr]'}${propTableRows ? `[tr]
[cell][/cell]
[cell][/cell]
    [td][b]TOTAL[/b][/td]
    [td][b]$${propTotalNominal.toLocaleString('en-US')}[/b][/td]
[cell][/cell]
[/tr]` : ''}
[/table]

I have also said that our finance team remains committed to providing the necessary support and information to management in making strategic decisions related to company finances. Thank you for the attention and trust given. If you have any additional questions or requests, please feel free to contact me.


[right]Sincerly,
[img]${sigUrl}[/img]
${rank}, ${staffName}[/right]

[/divbox][/divbox]`;
        } else if (viceSubTab === 'weekly') {
          const newMembers = document.getElementById('newMembers').value || '-';
          const transferMembers = document.getElementById('transferMembers').value || '-';
          const aiReport = document.getElementById('aiReport').value || '-';
          const aiCondition = document.getElementById('aiCondition').value || '-';
          const aiConstraints = document.getElementById('aiConstraints').value || '-';
          const additionalInfo = document.getElementById('additionalInfo').value || '-';
          const reportDate = document.getElementById('reportDate').value || new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

          bbCode = `[divbox=white][center][img]https://news.san-andreas.net/download/file.php?avatar=g69_1637211788.png[/img]
[b]Office Of Operation Division - Financial Regulator
Division Weekly Report[/b]
[hr][/hr][/center]

[b]Date:[/b] ${reportDate}
[b]Name:[/b] ${staffName}
[b]Rank:[/b] ${rank}

[b]Report:[/b] ${aiReport}

[b]Added New Members For Financial Regulator Divison:[/b] ${newMembers}
[list]
[/list]

[b]Transfer Members:[/b] ${transferMembers}
[list]
[/list]

[b]Division Condition:[/b] ${aiCondition}

[b]Constraints On The Division:[/b] ${aiConstraints}

[b]Additional Information:[/b] ${additionalInfo}
[right]
Sincerly,
[img]${sigUrl}[/img]
[b]${rank},[/b]
${staffName}[/right]
[/divbox]`;
        }
      }

      // Output to Textarea
      document.getElementById('output').value = bbCode;

      // Render Preview
      document.getElementById('preview').innerHTML = parseBBCode(bbCode);

      // Auto-switch to preview if it was empty before or user preference
      // Optional: switchTab('preview');
    }

    /* ===== COPY ===== */
    function copyBBCode() {
      if (!output.value) return;
      navigator.clipboard.writeText(output.value);

      const originalText = document.querySelector('button[onclick="copyBBCode()"]').innerHTML;
      const btn = document.querySelector('button[onclick="copyBBCode()"]');
      btn.classList.add('bg-emerald-900', 'border-emerald-700', 'text-emerald-100');
      btn.classList.remove('bg-slate-800', 'border-slate-700', 'text-slate-300');
      btn.innerHTML = `<span class="flex items-center gap-2 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>Copied!</span>`;

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('bg-emerald-900', 'border-emerald-700', 'text-emerald-100');
        btn.classList.add('bg-slate-800', 'border-slate-700', 'text-slate-300');
      }, 2000);
    }

    /* INIT */
    window.addEventListener('load', () => {
      loadIdentity();

      // Auto-set Date if empty
      const reportDateInput = document.getElementById('reportDate');
      if (reportDateInput && !reportDateInput.value) {
        reportDateInput.value = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
      }

      addReim();
      addProp();
      generateBBCode();

      // Register Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW Registered', reg))
          .catch(err => console.log('SW Failed', err));
      }
    });

    /* ===== GEMINI AI AUTOMATION ===== */
    async function generateWithAI() {
      const apiKey = document.getElementById('geminiKey').value.trim();
      const btn = document.getElementById('aiBtn');
      const icon = btn.querySelector('.ai-icon');

      if (!apiKey) {
        alert("Please enter a Gemini API Key first.");
        return;
      }

      // Gather context
      const staffName = document.getElementById('staffName').value || 'Michael Saylor';
      const rank = document.getElementById('rank').value || 'Manager of Financial Regulator Division';
      const summary = document.getElementById('aiSummary').value;
      const tone = document.getElementById('reportTone').value || 'Professional & Formal';

      let reims = [];
      document.querySelectorAll('#reimContainer > div').forEach(c => {
        const p = c.querySelector('.person').value;
        const n = c.querySelector('.nominal').value;
        if (p && n) reims.push(`${p} ($${n})`);
      });

      let props = [];
      document.querySelectorAll('#propContainer > div').forEach(c => {
        const t = c.querySelector('.type').value;
        const m = c.querySelector('.manager').value;
        const n = c.querySelector('.nominal') ? c.querySelector('.nominal').value : '0';
        if (t && m) props.push(`${t} by ${m} ($${n})`);
      });

      const prompt = `You are ${staffName}, ${rank}.
Write a professional weekly report for the Financial Regulator division in a San Andreas roleplay context.
Use a **${tone}** tone of voice throughout the report.

Details:
- Summary Highlights: ${summary || 'Regular operations, no significant issues.'}
- Reimbursements processed: ${reims.join(', ') || 'None'}
- Proposals handled: ${props.join(', ') || 'None'}

Please provide the content in Indonesian language.
The output MUST be in this exact format with markers:
[REPORT]
(A paragraph about the activities this week, focusing on how proposals and reimbursements was handled smoothly following SOP)

[CONDITION]
(A sentence about the division's current operational status, team coordination, and SOP compliance)

[CONSTRAINTS]
(A sentence about any issues like inactivity due to holidays, structure changes, or technical delays, OR state that there are no constraints)

Keep it realistic for a financial oversight division.`;

      try {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        icon.classList.add('animate-spin');
        btn.innerText = "Generating...";

        // Detect available models automatically
        let modelsToTry = ["gemini-1.5-flash", "gemini-1.5-flash-latest"];
        try {
          console.log("Detecting available models...");
          const listResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
          const listData = await listResp.json();
          if (listData.models) {
            const available = listData.models
              .filter(m => m.supportedGenerationMethods.includes("generateContent"))
              .map(m => m.name.split('/').pop());
            console.log("Actually available models:", available);
            // Prioritize flash models, then pro models
            const prioritized = available.filter(m => m.includes('1.5-flash') || m.includes('2.0-flash'));
            const others = available.filter(m => !prioritized.includes(m) && (m.includes('flash') || m.includes('pro')));
            modelsToTry = [...prioritized, ...others];
            if (modelsToTry.length === 0 && available.length > 0) modelsToTry = [available[0]];
          }
        } catch (e) {
          console.warn("Model detection failed, using defaults", e);
        }

        let lastError = null;
        let success = false;
        let data = null;

        for (const modelId of modelsToTry) {
          try {
            console.log(`Trying Gemini model: ${modelId}...`);
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
              })
            });

            data = await response.json();

            if (response.ok && data.candidates && data.candidates.length > 0) {
              console.log(`Success with model: ${modelId}`);
              success = true;
              break;
            } else {
              const msg = data.error?.message || "Unknown error";
              console.warn(`Model ${modelId} failed: ${msg}`);
              lastError = msg;
            }
          } catch (e) {
            console.warn(`Fetch error for ${modelId}:`, e);
            lastError = e.message;
          }
        }

        if (!success) {
          throw new Error(lastError || "All Gemini models failed to respond. Check your API key and network.");
        }

        const text = data.candidates[0].content.parts[0].text;

        // Parse markers
        const reportMatch = text.match(/\[REPORT\]\s*([\s\S]*?)(?=\[CONDITION\]|$)/i);
        const conditionMatch = text.match(/\[CONDITION\]\s*([\s\S]*?)(?=\[CONSTRAINTS\]|$)/i);
        const constraintsMatch = text.match(/\[CONSTRAINTS\]\s*([\s\S]*?)$/i);

        if (reportMatch) document.getElementById('aiReport').value = reportMatch[1].trim();
        if (conditionMatch) document.getElementById('aiCondition').value = conditionMatch[1].trim();
        if (constraintsMatch) document.getElementById('aiConstraints').value = constraintsMatch[1].trim();

        generateBBCode();
      } catch (error) {
        console.error("Gemini Error:", error);
        alert("Gemini API Error: " + error.message);
      } finally {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        btn.innerHTML = `<svg class="w-5 h-5 ai-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> AI Automate`;
      }
    }
  </script>

  <style>
    /* Custom Scrollbar for Textarea */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #0f172a;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }

    /* Fade in animation */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.2s ease-out forwards;
    }
  </style>

</body>
<footer>
  <div class="max-w-5xl mx-auto px-6 md:px-12 py-8 text-center">
    <p class="text-slate-500 text-sm">
      &copy; 2026 Financial Regulator SANews. Made with <span class="text-red-500"></span> by Saylor/Haniff.
    </p>
  </div>
</footer>

</html>